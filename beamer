#!/bin/bash
# ==================================================================
# FILE     beamer
# MACHINE  all
# INFO     handles resolution in multi-monitor setup with dwm
#					 when mirroring is involved
#
# DATE     03.03.2016
# OWNER    Bischofberger
# ==================================================================

# Auto:
# 1. Auflösungen auflisten
# 2. Wähle grösste Beamer-Auflösung
# 3. Vergleiche in internen Auflösungen
#		 3a. Suche erfolgreich (1024x768 oder höher)
#				-> activateDualMode()
#    3b. Suche erfolglos													
#				-> Meldung und check, ob Auflösung grösser als internal
#						-> Falls ja   -> activateDualMode_panning()
#						-> Falls nein -> ???

# Manuell (-m|--manually):
# 1. Auflösungen auflisten
# 2. Beamer-Auflösung eingeben (x, y)
# 3. Panning? eingeben
# Tests fahren:
# Panning ja		-> Auflösung >= Internal? -> Ja, ok, Nein, Abbruch
# Panning Nein	-> Auflösung = InternalMax? -> Ja, ok, Nein, Abbruch

# Force (-f|--force):
# wie manuell, aber ohne Tests


INTERNAL="LVDS"
RES_INT_x="1366"
RES_INT_y="768"
RES_INT_LIST=("1366x768" \
							"1280x720" \
							"1152x768" \
							"1024x768")

EXTERNAL="VGA-0"
RES_EXT_x="1"
RES_EXT_y="1"

die(){
	echo -e "$0: Error: $1" >&2
	exit 1
}

listAllResolutions(){
	xrandr
}

printResolution(){
	echo "${1}x${2}"
}

getHighestExternalResolution(){
	# TODO
	echo "res"
}

#xrandr --output LVDS --mode 1366x768 --fb 1920x1200 --panning 1920x1200* --output VGA-0 --mode 1920x1200 --same-as LVDS
activateDualMode_panning(){
	xrandr	--output $INTERNAL --mode $RES_INT_MAX --fb $RES_EXT --panning $RES_EXT* \
					--output $EXTERNAL --mode $RES_EXT --same-as $INTERNAL
	echo "In order to get out of panning mode, you must kill dwm (Mod1-Shift-q)
				and therefore kill the X-server. (Bug in xrandr, 03.2016)"
}

# für 1024x768
activateDualMode(){
	xrandr --output $EXTERNAL --auto --same-as $INTERNAL --mode $RES_EXT
	xrandr --output $INTERNAL --mode $RES_EXT
}

# TODO: workaround for getting out of panning...
deactivateDualMode(){
	#xrandr --output $EXTERNAL --primary
	#xrandr --output $INTERNAL --primary
	read -p "Plug out external monitor and press [Enter]."
	xrandr --output $INTERNAL --mode `printResolution $RES_INT_x $RES_INT_y`
	xrandr >/dev/null
	xrandr --auto
}

readDesiredExternalResolution(){
	echo "Enter desired resolution of external:"
	echo -n "x:"
	read RES_EXT_x
	echo -n "y:"
	read RES_EXT_y
	echo -n "Input: "
	printResolution $RES_EXT_x $RES_EXT_y
}

# Test in Funktion scheint nicht zu gehen...
isExternalGreaterThanInternal(){
	if (( "$RES_EXT_x" > "$RES_INT_x" && "$RES_EXT_y" > "$RES_INT_y" )) ; then
		return 0  # 0 = true
	else
		return 1  # 1 = false
	fi
}

#isExternalEqualToInternal(){
#
#}

# Main ------------------------------------------------

# option handling

#RES_EXT_MAX=`getHighestExternalResolution`

#activateDualMode_panning
readDesiredExternalResolution
if isExternalGreaterThanInternal ; then 
	echo yeah
fi

deactivateDualMode

